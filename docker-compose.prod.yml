version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: unless-stopped
    env_file:
      - .env.production
    # env_file로 로드된 변수는 자동으로 컨테이너 환경 변수로 설정됩니다.
    # .env.production 파일에 모든 환경 변수를 설정하세요.
    # 예시:
    # DATABASE_URL=postgresql://user:password@your-rds-endpoint.region.rds.amazonaws.com:5432/dbname
    # REDIS_URL=redis://your-elasticache-endpoint.cache.amazonaws.com:6379
    # JWT_ACCESS_SECRET=your-secret
    # JWT_REFRESH_SECRET=your-secret
    ports:
      # 포트 매핑 (호스트:컨테이너)
      # 호스트 포트는 환경 변수 PORT로 설정하거나 기본값 3000 사용
      # 컨테이너 내부 포트는 항상 3000 (앱이 3000 포트에서 실행)
      - "3000:3000"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
